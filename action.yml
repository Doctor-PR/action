name: Doctor PR
description: Address code reviews automatically with AI
author: "Doctor PR"
branding:
  icon: "git-merge"
  color: "black"
inputs:
  anthropic_api_key:
    required: true
    description: The API key for the Anthropic API

  base_branch_name:
    required: true
    description: The name of the branch to merge into

  base_pull_request_number:
    required: true
    description: The number of the pull request to merge into

  review_id:
    required: true
    description: The ID of the review to address

  aider_message:
    required: true
    description: The message to send to Aider

  author_username:
    required: true
    description: The GitHub username of the PR author

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Configure Git
      shell: bash
      run: |
        git config --global user.email 202363839+Doctor-PR[bot]@users.noreply.github.com
        git config --global user.name Doctor-PR[bot]
    - name: Install Aider
      shell: bash
      run: curl -LsSf https://aider.chat/install.sh | sh
    - name: Run Aider
      id: run_aider
      shell: bash
      env:
        AIDER_YES_ALWAYS: true
        AIDER_AUTO_COMMITS: true
        AIDER_CACHE_PROMPTS: true
        ANTHROPIC_API_KEY: ${{ inputs.anthropic_api_key }}
        AIDER_MESSAGE: ${{inputs.aider_message}}
      run: |
        # Create a directory outside the Git repository
        mkdir -p /tmp/aider
        # Run aider and capture its output to a file outside the repo while also displaying it
        aider | tee /tmp/aider/output.txt
        # Store the output as a step output
        echo "aider_output<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/aider/output.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Extract Commit Message
      id: extract_commit
      shell: bash
      run: |
        # Search for the commit message pattern in the entire output file
        COMMIT_LINE=$(grep -E "Commit [a-f0-9]+ " /tmp/aider/output.txt | tail -n 1)

        if [ -n "$COMMIT_LINE" ]; then
          # Extract the commit message from the line
          COMMIT_MESSAGE=$(echo "$COMMIT_LINE" | sed -E 's/Commit [a-f0-9]+ (.*)/\1/')
        else
          # Fallback if no commit message is found
          COMMIT_MESSAGE="Fix from Fix PR[bot]"
        fi

        # Remove any quotes that might cause issues
        COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | tr -d '"')
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        # For debugging
        echo "Extracted commit message: $COMMIT_MESSAGE"
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        base: ${{inputs.base_branch_name}}
        branch: "${{inputs.base_branch_name}}-fix-${{inputs.review_id}}"
        author: "Doctor PR[bot] <202363839+Doctor-PR[bot]@users.noreply.github.com>"
        committer: "Doctor PR[bot] <202363839+Doctor-PR[bot]@users.noreply.github.com>"
        reviewers: ${{inputs.author_username}}
        title: ${{steps.extract_commit.outputs.commit_message}}
        body: |
          Address [review comment][1] for PR #${{inputs.base_pull_request_number}}
          Auto-generated by Doctor PR[bot]

          [1]: https://github.com/${{github.repository}}/pull/${{inputs.base_pull_request_number}}#pullrequestreview-${{inputs.review_id}}
